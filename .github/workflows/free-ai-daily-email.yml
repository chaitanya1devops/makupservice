name: Daily Plan (GitHub notification)

on:
  schedule:
    # 8:00 AM IST = 02:30 UTC, Monâ€“Fri
    - cron: "30 2 * * 1-5"
  workflow_dispatch: {}

# The token must be able to create/comment on issues
permissions:
  contents: read
  issues: write

jobs:
  notify:
    runs-on: ubuntu-latest
    env:
      TZ: Asia/Kolkata
      USERNAME: chaitanya1devops
      ISSUE_TITLE: "Daily Plan Notifications"

    steps:
      - name: Compose energetic message (Markdown)
        id: build
        run: |
          TODAY=$(date +"%A, %d %B %Y")
          # Write the markdown body using a quoted heredoc so YAML/shell won't parse emojis or asterisks
          cat > body.md <<'MD'
**ðŸš€ Good Morning, Chaitanya!**

Hereâ€™s your energetic plan for **${TODAY}** â€” letâ€™s own the day! ðŸ’ª

### âœ¨ Routine (Monâ€“Fri)
- â° **8:00** â€“ Wake up & energize
- ðŸ“š **8:00â€“10:00** â€“ Learning / personal activities
- ðŸ‹ï¸ **10:00â€“11:30** â€“ Gym
- ðŸ’¡ **11:30â€“12:30** â€“ Personal activities
- ðŸ§‘â€ðŸ’¼ **12:30â€“1:30** â€“ Get ready for office
- ðŸš• **1:30** â€“ Cab pickup
- ðŸ’» **2:00** â€“ Punch in & start strong
- ðŸ•š **11:00** â€“ Punch out
- ðŸ  **11:30â€“12:30** â€“ Personal time
- ðŸŒ™ **1:00** â€“ Sleep & recharge

### ðŸ”¥ Quick Wins
1. Triage emails & tickets (10m)  
2. Clear yesterdayâ€™s blockers (5m)  
3. Start one high-impact task

> â€œSmall consistent steps beat giant occasional leaps.â€ âœ…
MD
          # inject today's date into the template
          sed -i "s|\${TODAY}|$TODAY|g" body.md
          echo "bodyfile=body.md" >> "$GITHUB_OUTPUT"
          echo "subject=Your Energetic Daily Plan ðŸš€ â€” ${TODAY}" >> "$GITHUB_OUTPUT"

      - name: Ensure rolling issue exists (create if missing)
        id: ensure_issue
        uses: actions/github-script@v7
        with:
          script: |
            const {owner, repo} = context.repo;
            const title = process.env.ISSUE_TITLE;

            // list open issues and find exact title (no advanced search)
            let page = 1, found = null;
            while (true) {
              const res = await github.rest.issues.listForRepo({owner, repo, state: 'open', per_page: 100, page});
              found = res.data.find(i => i.title === title);
              if (found || res.data.length < 100) break;
              page++;
            }

            if (!found) {
              const created = await github.rest.issues.create({
                owner, repo,
                title,
                body: "This issue collects your weekday Daily Plan notifications.\n\n_One comment per day._",
                assignees: [process.env.USERNAME],
                labels: ["daily-notify"]
              });
              found = created.data;
            }

            core.setOutput('issue_number', String(found.number));

      - name: Post todayâ€™s plan as a comment (triggers GitHub email)
        uses: actions/github-script@v7
        env:
          BODY_PATH: ${{ steps.build.outputs.bodyfile }}
          USERNAME: ${{ env.USERNAME }}
          ISSUE_NUMBER: ${{ steps.ensure_issue.outputs.issue_number }}
        with:
          script: |
            const {owner, repo} = context.repo;
            const fs = require('fs');
            const bodyMd = fs.readFileSync(process.env.BODY_PATH, 'utf8');
            const text = `@${process.env.USERNAME}\n\n${bodyMd}`;

            await github.rest.issues.addAssignees({
              owner, repo,
              issue_number: Number(process.env.ISSUE_NUMBER),
              assignees: [process.env.USERNAME]
            });

            await github.rest.issues.createComment({
              owner, repo,
              issue_number: Number(process.env.ISSUE_NUMBER),
              body: text
            });

      - name: Log preview (subject + markdown)
        run: |
          echo "::group::SUBJECT"
          echo "${{ steps.build.outputs.subject }}"
          echo "::endgroup::"
          echo "::group::BODY (Markdown)"
          cat "${{ steps.build.outputs.bodyfile }}"
          echo "::endgroup::"
