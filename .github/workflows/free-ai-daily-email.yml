name: Daily Plan (GitHub notification)

on:
  schedule:
    # 8:00 AM IST = 02:30 UTC, Mon–Fri
    - cron: "30 2 * * 1-5"
  workflow_dispatch: {}

# ✅ give the workflow token rights to create/comment on issues
permissions:
  contents: read
  issues: write

jobs:
  notify:
    runs-on: ubuntu-latest
    env:
      TZ: Asia/Kolkata
      USERNAME: chaitanya1devops
      ISSUE_TITLE: "Daily Plan Notifications"

    steps:
      - name: Compose energetic message (Markdown)
        id: build
        run: |
          TODAY=$(date +"%A, %d %B %Y")
          cat > body.md <<'MD'
**🚀 Good Morning, Chaitanya!**

Here’s your energetic plan for **${TODAY}** — let’s own the day! 💪

### ✨ Routine (Mon–Fri)
- ⏰ **8:00** – Wake up & energize
- 📚 **8:00–10:00** – Learning / personal activities
- 🏋️ **10:00–11:30** – Gym
- 💡 **11:30–12:30** – Personal activities
- 🧑‍💼 **12:30–1:30** – Get ready for office
- 🚕 **1:30** – Cab pickup
- 💻 **2:00** – Punch in & start strong
- 🕚 **11:00** – Punch out
- 🏠 **11:30–12:30** – Personal time
- 🌙 **1:00** – Sleep & recharge

### 🔥 Quick Wins
1. Triage emails & tickets (10m)  
2. Clear yesterday’s blockers (5m)  
3. Start one high-impact task

> “Small consistent steps beat giant occasional leaps.” ✅
MD
          sed -i "s|\${TODAY}|$TODAY|g" body.md
          echo "subject=Your Energetic Daily Plan 🚀 — ${TODAY}" >> $GITHUB_OUTPUT
          echo "bodyfile=body.md" >> $GITHUB_OUTPUT

      - name: Ensure rolling issue exists (create if missing)
        id: ensure-issue
        uses: actions/github-script@v7
        with:
          script: |
            const {owner, repo} = context.repo;
            const title = process.env.ISSUE_TITLE;

            // List open issues and find by exact title (avoids advanced search deprecation)
            let page = 1, issueNumber = null;
            while (true) {
              const res = await github.rest.issues.listForRepo({
                owner, repo, state: 'open', per_page: 100, page
              });
              const match = res.data.find(i => i.title === title);
              if (match) { issueNumber = match.number; break; }
              if (res.data.length < 100) break;
              page++;
            }

            if (!issueNumber) {
              const created = await github.rest.issues.create({
                owner, repo,
                title,
                body: "This issue collects your weekday Daily Plan notifications.\n\n_One comment per day._",
                assignees: [process.env.USERNAME],
                labels: ["daily-notify"]
              });
              issueNumber = created.data.number;
            }

            core.setOutput('issue', issueNumber.toString());

      - name: Post today’s plan as a comment (triggers GitHub email)
        uses: actions/github-script@v7
        with:
          script: |
            const {owner, repo} = context.repo;
            const fs = require('fs');
            const issueNumber = Number('${{ steps.ensure-issue.outputs.issue }}');
            const body = fs.readFileSync(`${process.env.GITHUB_WORKSPACE}/${{ steps.build.outputs.bodyfile }}`, 'utf8');
            const text = `@${process.env.USERNAME}\n\n${body}`;

            // Ensure you're assigned (assignment also triggers notifications)
            await github.rest.issues.addAssignees({ owner, repo, issue_number: issueNumber, assignees: [process.env.USERNAME] });
            await github.rest.issues.createComment({ owner, repo, issue_number: issueNumber, body: text });

      - name: Log preview (subject + markdown)
        run: |
          echo "::group::SUBJECT"
          echo "${{ steps.build.outputs.subject }}"
          echo "::endgroup::"
          echo "::group::BODY (Markdown)"
          cat "${{ steps.build.outputs.bodyfile }}"
          echo "::endgroup::"
