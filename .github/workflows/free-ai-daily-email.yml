name: Free AI Daily Routine Email

on:
  schedule:
    # 8:00 AM IST = 02:30 UTC (Mon–Fri)
    - cron: "30 2 * * 1-5"
  workflow_dispatch: {}

jobs:
  email:
    runs-on: ubuntu-latest
    env:
      TZ: Asia/Kolkata
      HF_HOME: ${{ github.workspace }}/.hf-cache   # cache model between runs
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Restore Hugging Face cache
        uses: actions/cache@v4
        with:
          path: .hf-cache
          key: hf-cache-${{ runner.os }}-smollm2-360m
          restore-keys: |
            hf-cache-${{ runner.os }}-

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install deps
        run: |
          python -m pip install --upgrade pip
          pip install "transformers>=4.43" "accelerate>=0.33" "sentencepiece>=0.2" "sacremoses" "pandas"

      - name: Build context files
        id: ctx
        shell: bash
        run: |
          set -euo pipefail
          TODAY=$(date +%F)
          DOWL=$(date +%A) # Monday...
          DOW3=$(echo "$DOWL" | awk '{print tolower(substr($0,1,3))}') # mon/tue/...

          read_file(){ [ -f "$1" ] && cat "$1" || true; }

          ROUTINE="$(read_file tasks/routine.md)"
          WEEKDAY="$(read_file tasks/weekdays/${DOW3}.md)"
          DATENOTE="$(read_file tasks/dates/${TODAY}.md)"

          # Optional CSV tasks for today
          if [ -f tasks/tasks.csv ]; then
            TODAYLIST=$(awk -F, -v d="$TODAY" 'NR>1 && $1==d {print $2 " — " $3}' tasks/tasks.csv | sort)
          else
            TODAYLIST=""
          fi

          printf "%s" "$ROUTINE" > /tmp/routine.md
          printf "%s" "$WEEKDAY" > /tmp/weekday.md
          printf "%s" "$DATENOTE" > /tmp/datenote.md
          printf "%s" "$TODAYLIST" > /tmp/todaylist.txt

          echo "dow=$DOWL" >> $GITHUB_OUTPUT

      - name: Generate email with free OSS model
        id: gen
        shell: bash
        run: |
          cat > gen_email.py << 'PY'
          import os, datetime, textwrap, pandas as pd
          from transformers import AutoModelForCausalLM, AutoTokenizer, pipeline

          # Tiny, permissive model (Apache-2.0) suitable for CPU:
          # SmolLM2-360M-Instruct ~140–180MB download
          MODEL_ID = "HuggingFaceTB/SmolLM2-360M-Instruct"

          def read(path):
            return open(path, "r", encoding="utf-8").read().strip() if os.path.exists(path) else ""

          routine   = read("/tmp/routine.md")
          weekday   = read("/tmp/weekday.md")
          datenote  = read("/tmp/datenote.md")
          todaylist = read("/tmp/todaylist.txt")

          today = datetime.datetime.now().strftime("%a, %d %b %Y")
          sys_prompt = (
            "You are a concise executive assistant. "
            "Write a warm, focused morning email with sections: Schedule, Top 3 Priorities, Quick Wins. "
            "Keep under 200 words. Use clear bullets. End with a one-line motivational nudge. "
            "If 14:00 punch-in or 23:00 punch-out are missing, include them in Schedule."
          )

          user_context = f"""
          Date: {today}
          Fixed routine (Mon–Fri):
          ---
          {routine}
          ---
          Weekday extras:
          ---
          {weekday}
          ---
          Date-specific notes:
          ---
          {datenote}
          ---
          Items scheduled for today:
          ---
          {todaylist}
          ---
          """

          tok = AutoTokenizer.from_pretrained(MODEL_ID, trust_remote_code=True)
          mdl = AutoModelForCausalLM.from_pretrained(MODEL_ID, trust_remote_code=True)
          gen = pipeline("text-generation", model=mdl, tokenizer=tok, device_map="auto")

          prompt = (
              f"<|system|>\n{sys_prompt}\n</|system|>\n"
              f"<|user|>\n{user_context}\nWrite subject line as the first line: 'Today’s Plan — {today}'. "
              f"Then the email body on following lines.\n</|user|>\n<|assistant|>\n"
          )

          out = gen(prompt, max_new_tokens=350, do_sample=True, temperature=0.6, top_p=0.9)[0]["generated_text"]
          # Extract assistant reply after the last assistant tag if present
          body_start = out.rfind("<|assistant|>")
          content = out[body_start+len("<|assistant|>"):] if body_start != -1 else out

          # First line is subject; rest is body
          lines = [l for l in content.strip().splitlines() if l.strip()]
          subject = lines[0] if lines else f"Today’s Plan — {today}"
          email_body = "\n".join(lines[1:]) if len(lines) > 1 else "Have a focused day!"

          with open("subject.txt", "w", encoding="utf-8") as f: f.write(subject.strip())
          with open("body.txt", "w", encoding="utf-8") as f:  f.write(email_body.strip())
          PY
          python gen_email.py
          echo "subject=$(cat subject.txt)" >> $GITHUB_OUTPUT
          echo "bodyfile=body.txt" >> $GITHUB_OUTPUT

      - name: Send email
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: ${{ secrets.SMTP_HOST }}
          server_port: ${{ secrets.SMTP_PORT }}
          username: ${{ secrets.SMTP_USERNAME }}
          password: ${{ secrets.SMTP_PASSWORD }}
          from: ${{ secrets.MAIL_FROM }}
          to: ${{ secrets.MAIL_TO }}
          subject: ${{ steps.gen.outputs.subject }}
          body: file:${{ steps.gen.outputs.bodyfile }}

